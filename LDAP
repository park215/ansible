#!/bin/bash

yum install -y git 
cd /tmp
git clone https://github.com/nic-instruction/hello-nti-310.git

yum install -y openldap-servers openldap-clients

cp /usr/share/openldap-servers/DB_CONFIC.example /var/lib/ldap/DB_CONFIG 
chown ldap. /var/lib/ldap/DB_CONFIG

systemctl enable slapd 
systemctl start slapd

yum install -y httpd phpldapadmin

#Let's SELinux know what is going on 
setsebool -P httpd_can_connect_ldap on

systemctl enable httpd 
systemctl start httpd

sed -i 's,Require local,#Require local\n Require all granted,g' /etc/httpd/conf.d/phpldapadmin.conf

unalias cp
cp /etc/phpldapadmin/config.php /etc/phpldapadmin/config.php.orig         #	make a copy of the origonal config file, we need the blowfish key
grep 'config.*blow£ish' /etc/phpldapadmin/config.php.orig                 #	grep for the blowfish key so we can see it in the logs
rightkey=$( grep 'config.*blowfish' /etc/phpldapadmin/config.php.orig )   #	use some rejex to get just the key and shove it into the variable 'right key
cp /tmp/hello-nti-310/config/config.php /etc/phpldapadmin/config.php      # copy our pre-made config to config.php

sed -i "s/\$config->custom->session\['blowfish'\] = '6ad461451893aaf046e2057e7870ae4'\; #Autogenerated for ldap-c/$rightkey/g" /etc/phpldapadmion/config.php #fix the key
chown ldap:apache /etc/phpldapadmin/config.php

systemctl restart httpd

echo "phpldapadmin is now up and running" 
echo "we are configuring ldap and ldapadmin

#Generates and stores new passwd securely
newsecret=${slappasswd -g)
newhash=$(slappasswd -s "$newsecret")
echo -n "$newsecret" > /root/ldap_admin_pass
chmod 0600 /root/ldap_admin_pass

echo -e "dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=nti310,dc=local
\n
dn: olcDatabase-{2}hdb,cn-config
changetype: modify
replace: olcRootDN
olcRootDN : cn=ldapadm,dc=nti310,dc=local
\n
dn: olcDatabase-{2}hdb,cn-config
changetype: modify
replace:olcRootPW 
olcRootPW: Snewhash" > db.ldif

ldapmodify -Y EXTERNAL -H ldapi:/// -f db.ldif

#Auth restriction

echo 'dn: olcDatabase={l}monitor,cn-config 
changetype: modify 
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=O,cn=peercred,cn=external,cn=auth" read by dn.base="cn=ldapm,dc=nti310,dc=local" read by 8 none' > monitor.ldif

ldapmodify -Y EXTERNAL -H ldapi:/// -f monitor.ldif

#Generates Certs

openssl req -new -x509 -nodes -out /etc/openldap/certs/nti310ldapcert.pem -keyout /etc/opentdap/certs/nti310ldapkey.pem -days 3

chown -R ldap, /etc/openldap/certs/nti*.pem

echo -e "dn: cn=config
changetype: modify
replace: olcTLSCertificateFile
olcTLSCertificateFile: /etc/openldap/certs/nti310ldapcert.pem 
\n
dn: cn=config
changetype: modify
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/nti310ldapkey.pem” > certs.Idif



ldapmodify -Y EXTERNAL -H ldapi:/// -f corts.ldif

# Test to see if cert config works 
slaptest -u
echo "it works"

unalias cp

ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schoma/cosine.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif

#Creates group and people structure base

echo -e "dn: dc=nti310,dc=local
de: nti310
objectClass: top
objectClass: domain
\n
dn: cn=ldapadm ,dc=nti310,dc=local
objectClass: organizationalRole
cn: ldapadm
description: LDAP Manager
\n
dn: ou=People,dc=nti310,dc=local 
objectClass: organizationalunit
ou: People 
\n
dn: ou=Group,dc=nti310,dc=local
objectClass: organizationalunit 
ou: Group" > base.ldif

setenforce 0

ldapadd -x -W -D "cn-ldapadm,dc=nti310,dc=local" -f base.ldif -y /root/ldap_admin_pass 

systemctl restart httpd
